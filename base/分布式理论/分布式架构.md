# 分布式理论

## ACID

![ACID隔离级别](./img/ACID.jpg)

## CAP

* CAP:Consistency:一致性、Availability:可用性、Partition tolerance:分区容错性
* 最多只能同时满足两项

### 一致性

* 多个副本之间是否能够保持数据一致的特性，即一个节点数据更新后，另一个节点的数据也应到更新，这是一种强一致性。

### 可用性

* 可用性是指系统提供的服务必须一直处于可用状态，对于用户的每一个操作请求都可以在有限的时间内返回结果。

### 分区容错性

* 分区容错性约束了一个分布式系统具有的特性，分布式系统在遇到任何网络分区故障的时候，仍然需要能够保证对外提供满足一致性和可用性的服务，除非整个网络环境都发生了故障。

## BASE

* Basically Availabe(基本可用)、Soft state(软状态)和Eventually consistent(最终一致性)，是对CAP中一致性和可用性权衡的结果。

### 基本可用

* 响应时间上的损失:正常来说响应时0.5s，发生故障时可以维持在2～3s左右
* 功能上的损失:服务降级方式保证基本可用

### 软状态

* 运行系统中的数据存在中间状态，并认为该中间状态的存在不会影响整个系统的可用性，即运行系统在不同节点上的数据副本之间进行数据同步的过程存在延时。

### 最终一致性

* 系统中所有的数据副本在经过一段时间的同步后，最终能够达到一个一致的状态。

#### 最终一致性的变体

* 因果一致性:如果进程A在更新完某个数据后通知了进程B，那么进程B之后对该数据的访问都应该能够获取A更新后的最新值，并且如果进程B要对该数据进行更新的话，务必基于进程A更新后的最新值。
* 读己之所写:进程A更新一个数据项之后，它自己总是能够访问到更新过的最新值，而不会看到旧值。
* 会话一致性:对系统数据的访问过程框定在了一个会话当中:系统能保证在同一个有效的会话中实现"读己之所写"的一致性，执行更新操作后，客户端能够在同一个会话中始终读取到该数据项的最新值。
* 单调读一致性:如果一个进程从系统中读取出一个数据的某值后，那么系统对于该进程后续的任何数据访问都不应该返回更旧的值。
* 单调写一致性:一个系统需要能保证来自同一个进程的写操作被顺序执行。

# 一致性协议

## 2PC

* Two-Phase Commit二阶段提交为了使分布式系统架构下所有节点在进行事务处理过程中能够保证原子性和一致性设计的算法。

### 2PC阶段

#### 阶段一:提交事务请求(投票阶段)

* 事务询问:协调者向所有的参与者发送事务内容，询问是否可以执行事务提交操作，并开始等待各参入者的响应。
* 执行事务:各参与者节点执行事务操作，并将Undo和Redo信息记入事务日志中。
* 各参与者向协调者反馈事务询问的响应
  * 如果参与者成功执行了事务操作，那么就反馈给协调者"Yes"响应，表示事务可以执行，如果参与者没有成功执行事务，就返回"NO"响应，表示事务不可以执行。

#### 阶段二:执行事务提交

* 协调者更加各个参与者反馈情况来决定最终是否可以进行事务提交操作，正常来说存在俩种情况。
* 执行事务提交，所有参入者都反馈了"YES"响应
  * 发送提交请求:协调者向所有参入者发送Commit请求。
  * 事务提交:参与者接收到Commit请求后，正式执行事务提交操作，并在完成提交之后释放在整个事务执行期间占用的事务资源。
  * 反馈事务提交结果:参与者在完成事务提交后，向协调者发送Ack消息。
  * 完成事务:协调者接收到所有参与者反馈的Ack消息后，完成事务。

![2PC事务提交](./img/2PC事务提交.jpg)

* 中断事务,又参与者反馈了"No"响应
  * 发送回滚请求:协调者向所有参与者发送Rollback请求。
  * 事务回滚:参与者接收到Rollback请求后，会利用其在阶段一中记录的Undo信息来执行事务回滚操作，并在完成回滚之后释放在整个事务执行期间占用的资源。
  * 反馈事务回滚结果:参与者在完成事务回滚之后，向协调者发送Ack消息。
  * 中断事务:协调者接收到所有参与者反馈到Ack消息后，完成事务中断。

![2PC事务提交](./img/2PC事务中断.jpg)

### 优缺点

* 优点:原理简单，实现方便。
* 缺点:同步阻塞、单点问题、脑裂。

#### 同步阻塞

* 2PC存在同步阻塞问题，所有参与该事务操作的逻辑都处于阻塞状态，各个参与者都在等待对方返回响应给协调者，然后在等待协调者给相应的事务操作。

#### 单点问题

* 协调者存在单点问题，一旦协调者挂掉就会导致事务无法提交并且锁定事务资源的状态。

#### 数据不一致性

* 在协调者发送commit请求出现宕机导致部分参与者没有接收到commit请求，最终一部分参与者提交了事务，一部分参与者没有提交事务，导致数据不一致性问题。

#### 容错不健全

## 3PC

* Three-Phase Commit三阶段提交，是2PC的改进版，将2PC的"投票阶段"氛围CanCommit、PreCommit。

![3Pc](./img/3PC.jpg)

### 阶段一:CanCommit

#### 事务询问

* 协调者向所有参与者发送一个包含事务内容的canCommit请求，询问是否可以执行事务提交操作，并开始等待各参与者的响应

#### 各参与者向协调者反馈事务询问的响应

* 参与者在接收到协调者的canCommit请求后，正常情况下，如果其自身认为可以顺利执行事务，那么会反馈Yes响应，进入预备状态，否则反馈No响应。

### 阶段二:PreCommit

* 协调者会根据各个参与者的反馈情况来决定是否可以进行事务的PreCommit操作，存在俩种情况。

#### 执行事务预提交

* 发送预提交请求:协调者向所有参与者节点发送preCommit的请求，并进入Prepared阶段。
* 事务预提交:参与者接收到preCommit请求后，会执行事务操作，并将Undo和Redo信息记录到事务日志中。
* 各个参与者向协调者反馈事务执行的响应：如果参与者成功执行事务操作，那么就会反馈给协调者Ack响应，同时等待最终的指令:提交(commit)或中止(abort)

#### 中断事务

* 如果有任何一个参与者反馈No响应，则中断事务。
* 发送中断请求:协调者向所有参与者节点发送abort请求
* 中断事务:无论是收到来自协调组的abort请求或是等待协调者请求过程中出现超时，参与者都会中断事务。

### 阶段三:doCommit

#### 执行提交

* 发送提交请求:假设协调者工作正常，并且它接收到了来自所有参与者的Ack响应，那么它将从"预提交"状态转换到"提交"状态，并向所有参与者发送doCommit请求。
* 事务提交:参与者接收到doCommit请求后，会正式执行事务提交操作，并在完成提交之后释放在整个事务执行期间占用的事务资源。
* 反馈事务提交结果:参与者在完成事务提交之后，向协调者发送Ack消息
* 完成事务:协调者接收到所有参与者反馈的Ack消息后，完成事务。

#### 中断事务

* 发送中断请求:协调者先所有参与者节点发送abort请求
* 事务回滚:参与者接收到abort请求后，会利用其在阶段二中记录的Undo信息来执行事务回滚操作，并在完成回滚之后释放在整个事务执行期间占用的资源。
* 反馈事务回滚结果:参与者在完成事务回滚之后，向协调者发送Ack消息。
* 中断事务:协调者接收到所有参与者的Ack消息后，中断事务。

### 优缺点

* 优点：降低参与者的阻塞范围
* 缺点：仍然存在数据一致性问题

